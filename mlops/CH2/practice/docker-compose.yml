services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ch2-api
    env_file:
      - .env
    ports:
      - "8001:8000"
    depends_on:
      - qdrant
      - vllm

  qdrant:
    image: qdrant/qdrant:latest
    container_name: ch2-qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage

  vllm:
    image: public.ecr.aws/q9t5s3a7/vllm-cpu-release-repo:latest
    container_name: ch2-vllm
    command: >
      --model microsoft/Phi-4-mini-4k-instruct
      --host 0.0.0.0
      --port 8000
      --device cpu
      --dtype float32
      --max-model-len 2048
      --trust-remote-code
    ports:
      - "8000:8000"
    environment:
      - HF_HOME=/root/.cache/huggingface
    volumes:
      - hf_cache:/root/.cache/huggingface

volumes:
  qdrant_data:
  hf_cache:
